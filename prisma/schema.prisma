generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// admin.prisma
// ##########----------Admin Model----------##########
model Admin {
    id           String   @id @default(uuid())
    customUserId String   @unique
    name         String
    joiningDate  DateTime @default(now())
    isActive     Boolean  @default(true)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    customUser CustomUser @relation(fields: [customUserId], references: [id], onDelete: Cascade)
}

// agent.prisma
model Agent {
    id            String     @id @default(uuid())
    customUserId  String     @unique
    designation   String?
    department    String?
    joiningDate   DateTime   @default(now())
    isActive      Boolean    @default(true)
    createdAt     DateTime   @default(now())
    updatedAt     DateTime   @updatedAt

    customUser    CustomUser @relation(fields: [customUserId], references: [id], onDelete: Cascade)
}

// course.prisma
// ##########----------Course Model----------##########
model Course {
    id        String   @id @default(uuid())
    partnerId String
    name      String
    code      String
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    partner      Partner           @relation(fields: [partnerId], references: [id], onDelete: Cascade)
    loanSchemes  LoanScheme[]
    applications LoanApplication[]
}

// customUser.prisma
// ####################--------------------Custom User Model--------------------####################
model CustomUser {
    id                String   @id @default(uuid())
    email             String?  @unique
    name              String?
    mobile            String   @db.VarChar(10)
    userType          UserType
    password          String
    accessToken       String?
    refreshToken      String?
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    agent             Agent?
    admin             Admin?
}

// enums.prisma
// ##########----------Custom User Enums----------##########
enum UserType {
  AGENT
  ADMIN
}

// ##########----------Gender Enums----------##########
enum Gender {
    MALE
    FEMALE
    OTHER
}

// ##########----------Loan Status Enums----------##########
enum LoanStatus {
  PENDING
  APPROVED
  ENACH_PENDING
  ENACH_ACTIVE
  DISBURSED
  CLOSED
}

// ##########----------Interest Type Enums----------##########
enum InterestType {
    FLAT
    REDUCING
}

// ##########----------Interest Paid By Enums----------##########
enum InterestPaidBy {
    STUDENT
    PARTNER
}

// ##########----------Payment Mode Enums----------##########
enum PaymentMode {
  ONLINE
  CASH
  CHEQUE
  BANK_TRANSFER
  UPI
}

// ##########----------Mandate Status Enums----------##########
enum MandateStatus {
  CREATED
  AUTHENTICATED
  CONFIRMED
  ACTIVE
  PAUSED
  CANCELLED
  COMPLETED
}

// ##########----------EMI Status Enums----------##########
enum EMIStatus {
  PENDING
  SCHEDULED
  PROCESSING
  SUCCESS
  FAILED
  SKIPPED
}

// ##########----------Payment Status Enums----------##########
enum PaymentStatus {
  CREATED
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}


// loanApplication.prisma
// ##########----------Loan Application Model----------##########
model LoanApplication {
    id             String     @id @default(uuid())
    refId          String     @unique
    partnerId       String
    courseId        String
    schemeId        String
    applicantName  String
    applicantPhone String
    applicantEmail String
    applicantGender Gender
    guardianName   String
    guardianPhone  String
    guardianEmail  String
    relationship   String
    monthlyIncome  Int        @default(0)
    bankStatement  String?
    admissionDoc   String?
    fees           Float
    loanAmount     Float?
    interestRate   Float?
    tenure         Int?
    emiAmount      Float?
    status         LoanStatus @default(PENDING)
    createdAt      DateTime   @default(now())
    updatedAt      DateTime   @updatedAt

    partner            Partner             @relation(fields: [partnerId], references: [id])
    course             Course              @relation(fields: [courseId], references: [id])
    scheme             LoanScheme          @relation(fields: [schemeId], references: [id])

    kyc                KYC?
    eNachMandate       ENachMandate?
    disbursement       Disbursement?
    loanAccount        LoanAccount?
    closureCertificate ClosureCertificate?
}

// ##########----------KYC Model----------##########
model KYC {
    id                  String    @id @default(uuid())
    loanApplicationId   String    @unique
    studentAadharFront  String?
    studentAadharBack   String?
    studentPanCard      String?
    guardianAadharFront String?
    guardianAadharBack  String?
    guardianPanCard     String?
    videoKycLink        String?
    isVKYCApproved      Boolean   @default(false)
    submittedAt         DateTime  @default(now())
    approvedAt          DateTime?

    loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
}

// ##########----------E-NACH Mandate Model----------##########
model ENachMandate {
    id                String        @id @default(uuid())
    loanApplicationId String        @unique
    mandateId         String        @unique
    tokenId           String?       @unique
    customerId        String
    bankAccountNo     String        @default("")
    ifscCode          String        @default("")
    accountType       String        @default("savings")
    maxAmount         Float
    startDate         DateTime
    endDate           DateTime?
    status            MandateStatus @default(CREATED)
    authType          String        @default("netbanking")
    authLink          String?
    createdAt         DateTime      @default(now())
    updatedAt         DateTime      @updatedAt

    loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
    emiSchedules    EMISchedule[]
    autoPayments    AutoPayment[]
}

// ##########----------EMI Schedule Model----------##########
model EMISchedule {
    id            String    @id @default(uuid())
    mandateId     String
    emiNumber     Int
    emiAmount     Float
    scheduledDate DateTime
    status        EMIStatus @default(PENDING)
    paidDate      DateTime?
    paymentId     String?
    failureReason String?
    retryCount    Int       @default(0)
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    mandate ENachMandate @relation(fields: [mandateId], references: [id], onDelete: Cascade)
}

// ##########----------Auto Payment Model----------##########
model AutoPayment {
    id                String        @id @default(uuid())
    mandateId         String
    loanApplicationId String
    loanAccountId     String?
    razorpayPaymentId String        @unique
    razorpayOrderId   String?
    amount            Float
    status            PaymentStatus @default(CREATED)
    paymentDate       DateTime?
    principalAmount   Float?
    interestAmount    Float?
    method            String?
    failureReason     String?
    createdAt         DateTime      @default(now())
    updatedAt         DateTime      @updatedAt

    mandate ENachMandate @relation(fields: [mandateId], references: [id], onDelete: Cascade)
}

// ##########----------Disbursement Model----------##########
model Disbursement {
    id                String          @id @default(uuid())
    loanApplicationId String          @unique
    disbursedAmount   Float
    interestRate      Float
    tenure            Int
    advanceEMIPaid    Boolean         @default(false)
    advanceEMIAmount  Float?
    interestPaidBy    InterestPaidBy?
    disbursedAt       DateTime        @default(now())

    loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
}

// ##########----------Loan Account Model----------##########
model LoanAccount {
    id                String      @id @default(uuid())
    loanAccountNo     String      @unique
    loanApplicationId String      @unique
    principalAmount   Float
    interestAmount    Float
    totalOutstanding  Float
    totalPaid         Float       @default(0)
    repayments        Repayment[]
    utrDetails        UTRDetail[]
    createdAt         DateTime    @default(now())
    updatedAt         DateTime    @updatedAt

    loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
}

// ##########----------Repayment Model----------##########
model Repayment {
    id               String      @id @default(uuid())
    loanAccountId    String
    amountPaid       Float
    paymentDate      DateTime
    paymentMode      PaymentMode
    utrId            String?
    screenshot       String?
    principalAmount  Float
    interestAmount   Float
    totalOutstanding Float
    createdAt        DateTime    @default(now())
    updatedAt        DateTime    @updatedAt

    loanAccount LoanAccount @relation(fields: [loanAccountId], references: [id], onDelete: Cascade)
}

// ##########----------UTR Detail Model----------##########
model UTRDetail {
    id            String      @id @default(uuid())
    loanAccountId String
    utrId         String      @unique
    amountPaid    Float
    paymentDate   DateTime
    paymentMode   PaymentMode
    screenshot    String?
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt

    loanAccount LoanAccount @relation(fields: [loanAccountId], references: [id], onDelete: Cascade)
}

// ##########----------Closure Certificate Model----------##########
model ClosureCertificate {
    id                String   @id @default(uuid())
    loanApplicationId String   @unique
    certificateUrl    String?
    closedDate        DateTime @default(now())
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
}


// loanScheme.prisma
// ##########----------Loan Scheme Model----------##########
model LoanScheme {
    id             String        @id @default(uuid())
    partnerId      String
    courseId       String
    schemeName     String        @unique
    interestType   InterestType
    interestPaidBy InterestPaidBy
    isActive       Boolean       @default(true)
    createdAt      DateTime      @default(now())
    updatedAt      DateTime      @updatedAt

    partner      Partner           @relation(fields: [partnerId], references: [id], onDelete: Cascade)
    course       Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
    applications LoanApplication[]
}

// partner.prisma
// ##########----------Partner Model----------##########
model Partner {
    id        String   @id @default(uuid())
    name      String   @unique
    code      String   @unique
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    courses      Course[]
    loanSchemes  LoanScheme[]
    applications LoanApplication[]
}